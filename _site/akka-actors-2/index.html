<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.9.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Data processing with Akka Actors: Part II - Aleksandar Skrbic</title>
<meta name="description" content="Scala, Akka, JVM, Big Data">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Aleksandar Skrbic">
<meta property="og:title" content="Data processing with Akka Actors: Part II">
<meta property="og:url" content="http://localhost:4000/akka-actors-2/">


  <meta property="og:description" content="Scala, Akka, JVM, Big Data">



  <meta property="og:image" content="http://localhost:4000/images/akka/akka-h1.jpg">





  <meta property="article:published_time" content="2020-04-10T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/akka-actors-2/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Aleksandar Skrbic",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Aleksandar Skrbic Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">Aleksandar Skrbic</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/search/" >Search Articles</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/about/" >About</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      
  











<div class="page__hero"
  style=" "
>
  
    <img src="http://localhost:4000/images/akka/akka-h1.jpg" alt="Data processing with Akka Actors: Part II" class="page__hero-image">
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Aleksandar Skrbic</h3>
    
    
      <p class="author__bio" itemprop="description">
        Blogging mostly about distributed systems, databases and big data.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Novi Sad, Serbia</span>
        </li>
      

      

      
        <li>
          <a href="mailto:skrbic.alexa@gmail.com">
            <meta itemprop="email" content="skrbic.alexa@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> Email
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/skrbic_a" itemprop="sameAs">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter
          </a>
        </li>
      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/aleksandar-skrbic" itemprop="sameAs">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/aleksandarskrbic" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Data processing with Akka Actors: Part II">
    <meta itemprop="description" content="Scala, Akka, JVM, Big Data">
    <meta itemprop="datePublished" content="April 10, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Data processing with Akka Actors: Part II
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        
<p>In the <a href="/akka-actors-1/">first article</a> in the <em>Data processing with Akka Actors series</em>, I have introduced a problem that we are trying to solve. There was some talk about actors and how to organize them into an actor hierarchy. Then we got deep into details while implementing two simple actors with Scala describing message flow protocol between them and explaining the relationships among actors in the defined actor hierarchy.</p>

<p><em>Supervisor Actor</em> and <em>Ingestion Actor</em> are already implemented and discussed in detail and if you remember the actor hierarchy diagram from the <a href="/akka-actors-1/">first article</a> you know that we are going to implement two more actors: <em>Master Actor</em> and <em>Worker Actor</em>. Since <em>Master Actor</em> is the brain of our application, who is responsible for distributing incoming requests to workers and gathering results from them when data processing is finished, most complex actor among all, we will first implement <em>Worker Actor</em>.</p>

<h2 id="worker-actor">Worker Actor</h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Worker</span> <span class="o">{</span>
  <span class="k">final</span> <span class="k">object</span> <span class="nc">ResultRequest</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ResultResponse</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">state</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">])</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Date</span><span class="o">(</span><span class="n">month</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">year</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">hour</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Log</span><span class="o">(</span><span class="n">ip</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">Date</span><span class="o">,</span> <span class="n">url</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">status</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">props</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">Worker</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here is some already familiar pattern where first is implemented actors companion object, where message protocol is defined and also factory method that returns actor wrapped in a Props class which is immutable configuration object used for creating new actors through <em>actors system</em> or <em>actor context</em>.  If something is not clear in the previous sentence I recommend reading <a href="https://doc.akka.io/docs/akka/current/actors.html">this page</a> of Akka official documentation.</p>

<p>Now let’s talk about the message protocol. There are four defined messages:</p>
<ul>
  <li><strong>ResultRequest</strong>  is a message that is received by <em>Master Actor</em>, when there is no data left to process, which means, as a name suggest, that worker actor should return aggregated processing results to <em>Master Actor</em>.</li>
  <li><strong>ResultResponse</strong>  is, as you assumed,  a message that contains all data processed by a worker.</li>
  <li><strong>Date</strong> and <strong>Log</strong> case classes are our domain objects which are consturcted from <strong>Line</strong> message received by <em>Master Actor</em>.</li>
</ul>

<p>By now, as we are already familiar with a message flow through actors, we know that <strong>Line</strong> is just a wrapper class around line read from source by <em>Ingestion Actor</em> sent to <em>Master Actor</em> and finally forwarded to one of the <em>Worker Actors</em>. The goal of our application is to count the number of occurrences of HTTP status codes from file reading it line by line. So upon receiving <strong>Line</strong>,  <em>Worker Actor</em> should transform that to  <strong>Log</strong> case class. So here is an implementation of that function:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">WorkerHandler</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Worker._</span>

  <span class="k">def</span> <span class="nf">toLog</span><span class="o">(</span><span class="n">line</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Log</span> <span class="o">=</span> <span class="nv">line</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="s">","</span><span class="o">).</span><span class="py">toList</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">ip</span> <span class="o">::</span> <span class="n">time</span> <span class="o">::</span> <span class="n">url</span> <span class="o">::</span> <span class="n">status</span> <span class="o">::</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="nv">date</span> <span class="k">=</span> <span class="nv">time</span><span class="o">.</span><span class="py">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nv">time</span><span class="o">.</span><span class="py">length</span><span class="o">).</span><span class="py">split</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="py">toList</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="k">_</span> <span class="o">::</span> <span class="n">month</span> <span class="o">::</span> <span class="n">timeParts</span> <span class="o">::</span> <span class="k">_</span> <span class="k">=&gt;</span>
          <span class="k">val</span> <span class="nv">year</span> <span class="k">=</span> <span class="nv">timeParts</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="s">":"</span><span class="o">)(</span><span class="mi">0</span><span class="o">).</span><span class="py">toInt</span>
          <span class="k">val</span> <span class="nv">hour</span> <span class="k">=</span> <span class="nv">timeParts</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="s">":"</span><span class="o">)(</span><span class="mi">1</span><span class="o">).</span><span class="py">toInt</span>
          <span class="nc">Date</span><span class="o">(</span><span class="n">month</span><span class="o">,</span> <span class="n">year</span><span class="o">,</span> <span class="n">hour</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="nc">Log</span><span class="o">(</span><span class="n">ip</span><span class="o">,</span> <span class="n">date</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">status</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Here is a simple function that just parses string that is extracted from <strong>Line</strong> case class and transforms it to <strong>Log</strong> case class. My implementation relies heavily on pattern matching because I like the way it allows us to deconstruct case classes and collections. If you want to found out more about pattern matching in Scala or you are not very clear about it, feel free to reach me or read <a href="https://docs.scala-lang.org/tour/pattern-matching.html">this</a>.</p>

<p>Finally, let’s review <em>Worker Actor</em> implementation:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Worker</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span>
 <span class="k">with</span> <span class="nc">ActorLogging</span>
 <span class="k">with</span> <span class="nc">WorkerHandler</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Worker._</span>

  <span class="k">type</span> <span class="kt">StatusCode</span> <span class="o">=</span> <span class="nc">String</span>
  <span class="k">type</span> <span class="kt">Count</span> <span class="o">=</span> <span class="nc">Long</span>

  <span class="k">var</span> <span class="n">state</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">StatusCode</span>, <span class="kt">Count</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Map</span><span class="o">.</span><span class="py">empty</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nv">Ingestion</span><span class="o">.</span><span class="py">Line</span><span class="o">(</span><span class="n">text</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="nv">status</span> <span class="k">=</span> <span class="nf">toLog</span><span class="o">(</span><span class="n">text</span><span class="o">).</span><span class="py">status</span>
      <span class="nv">state</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">status</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">state</span> <span class="o">+=</span> <span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
          <span class="n">state</span> <span class="o">+=</span> <span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="nc">ResultRequest</span> <span class="k">=&gt;</span>
      <span class="nf">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">ResultResponse</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">state</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>There are only a few lines of code, but to be sure let’s examine all details.</p>

<p>Starting from the beginning we could see <strong>state</strong> variable where processing results are stored.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">state</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">StatusCode</span>, <span class="kt">Count</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Map</span><span class="o">.</span><span class="py">empty</span>
</code></pre></div></div>

<p>Upon receiving <strong>Line</strong> message, <em>Worker Actor</em> transform it to <strong>Log</strong> and then update state with next logic:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">state</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">status</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">state</span> <span class="o">+=</span> <span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
  <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
    <span class="n">state</span> <span class="o">+=</span> <span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here we have some pattern matching again.
Since <em>Map</em> from Scala Collections returns <em>Option[V]</em>, we are able to pattern match against it. If there is some value we will get <em>Some(value)</em> and if <em>Option</em> is empty we will get <em>None</em>. To learn more about <em>Option type</em> check <a href="https://www.scala-lang.org/api/current/scala/Option.html">this</a>.</p>

<p>And that is a full implementation of a <em>Worker Actors</em>, simple as that.</p>

<h2 id="master-actor">Master Actor</h2>

<p>This is the last chapter of this article where <em>Master Actor</em> implementation is going to be reviewed.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Master</span> <span class="o">{</span>
  <span class="k">final</span> <span class="k">object</span> <span class="nc">Initialize</span>
  <span class="k">final</span> <span class="k">object</span> <span class="nc">MasterInitialized</span>
  <span class="k">final</span> <span class="k">object</span> <span class="nc">CollectResults</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Aggregate</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">)])</span>

  <span class="k">def</span> <span class="nf">props</span><span class="o">(</span><span class="n">nWorkers</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">Master</span><span class="o">(</span><span class="n">nWorkers</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Since <em>Master Actor</em> have multiple behaviors, each will be explained separately. Let’s start with the initial behavior.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="nf">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Initialize</span> <span class="k">=&gt;</span>
    <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Spawning $nWorkers workers..."</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">workers</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">nWorkers</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="n">createWorker</span><span class="o">)</span>
    <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
    <span class="nf">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">MasterInitialized</span>
<span class="o">}</span>
</code></pre></div></div>

<p><em>Initialize</em> message that is received from <em>Ingestion Actor</em> will trigger the creation of <em>Worker Actors</em>. Number of workers is defined upon creating <em>Master Actor</em>. Here is the implementation of <em>createWorker</em> method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">createWorker</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span> 
  <span class="nv">context</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nv">Worker</span><span class="o">.</span><span class="py">props</span><span class="o">(</span><span class="n">index</span><span class="o">),</span> <span class="n">s</span><span class="s">"worker-$index"</span><span class="o">)</span>
</code></pre></div></div>

<p>After workers are initialized, they are ready to start receiving tasks from their parent.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
</code></pre></div></div>

<p>This code snippet(above) basically tells actors how to react to the next message.
Actors <em>context.become</em> method takes a <em>PartialFunction[Any, Unit]</em> that implements the new message handler.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="nc">PartialFunction</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Unit</span><span class="o">]</span>
</code></pre></div></div>
<p><em>Receive</em> type that is seen in code is just Akka alias for <em>PartialFunction[Any, Unit]</em>.</p>

<p>Now, after this is clear, let’s review <em>forwadTask</em> behavior:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">],</span>
                <span class="n">currentWorker</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">line</span> <span class="k">@</span> <span class="nv">Ingestion</span><span class="o">.</span><span class="py">Line</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">worker</span> <span class="k">=</span> <span class="nf">workers</span><span class="o">(</span><span class="n">currentWorker</span><span class="o">)</span>
    <span class="n">worker</span> <span class="o">!</span> <span class="n">line</span>
    <span class="k">val</span> <span class="nv">nextWorker</span> <span class="k">=</span> <span class="o">(</span><span class="n">currentWorker</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="nv">workers</span><span class="o">.</span><span class="py">length</span>
    <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="n">nextWorker</span><span class="o">))</span>
  <span class="k">case</span> <span class="nc">CollectResults</span> <span class="k">=&gt;</span>
    <span class="nv">workers</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="k">_</span> <span class="o">!</span> <span class="nv">Worker</span><span class="o">.</span><span class="py">ResultRequest</span><span class="o">)</span>
    <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">collectResults</span><span class="o">())</span>
<span class="o">}</span>
</code></pre></div></div>
<p>In this behavior <em>Master Actor</em> react on two type of messages: <em>Line</em> and <em>CollectResults</em>.</p>

<p>When <em>Line</em> is received, we will have access to <em>workers</em> which is collection of all <em>Worker Actors</em> and <em>currentWorker</em>  which is the index of <em>Worker Actor</em> to whom the incoming message will be passed. After the message is sent to the wanted worker, we need to determine the index of the next <em>Worker Actor</em> who will need to receive the next message.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">nextWorker</span> <span class="k">=</span> <span class="o">(</span><span class="n">currentWorker</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="nv">workers</span><span class="o">.</span><span class="py">length</span>
<span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="n">nextWorker</span><span class="o">))</span>
</code></pre></div></div>

<p>In the first line of code <em>nextWorker</em> index is determined in a round-robin fashion, and the next line is the same as one we explained before. You can capture the pattern that we are using to carry the state via method arguments.</p>

<p>When <em>CollectResults</em> message is received, we just iterate over <em>workers</em> and request results from them, after that <em>Master Actor</em> behavior is switched to <em>collectResults</em>, when it’s ready to handle responses from all <em>workers</em>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">results</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ArrayBuffer</span><span class="o">[</span><span class="kt">Worker.ResultResponse</span><span class="o">]()</span>

<span class="k">def</span> <span class="nf">collectResults</span><span class="o">()</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">response</span> <span class="k">@</span> <span class="nv">Worker</span><span class="o">.</span><span class="py">ResultResponse</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">results</span> <span class="o">+=</span> <span class="n">response</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">results</span><span class="o">.</span><span class="py">length</span> <span class="o">==</span> <span class="n">nWorkers</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">context</span><span class="o">.</span><span class="py">parent</span> <span class="o">!</span> <span class="nf">toAggregate</span><span class="o">(</span><span class="nv">results</span><span class="o">.</span><span class="py">toSeq</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here you can see that we introduced <em>results</em> which is a collection of all received messages from workers. When all results are collected from workers, we will transform responses to the final result and pass it to the parent(<em>Ingestion Actor</em>).</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">MasterHandler</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">toAggregate</span><span class="o">(</span><span class="n">results</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Worker.ResultResponse</span><span class="o">])</span><span class="k">:</span> <span class="kt">Aggregate</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">aggregate</span> <span class="k">=</span> <span class="n">results</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">state</span><span class="o">)</span>
      <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">toList</span><span class="o">)</span>
      <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">_1</span><span class="o">)</span>
      <span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="nf">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="nv">v</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">_2</span><span class="o">).</span><span class="py">sum</span> <span class="o">}</span>
      <span class="o">.</span><span class="py">toList</span>
      <span class="o">.</span><span class="py">sortBy</span><span class="o">(</span><span class="nv">_</span><span class="o">.</span><span class="py">_2</span><span class="o">)</span>
    <span class="nc">Aggregate</span><span class="o">(</span><span class="n">aggregate</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In <em>MasterHandler</em> there is a method that transforms results to <em>Aggregate</em> case class, which is just a container for a collection of <em>Tuple(String, Long)</em>, where the first element of a tuple is a <em>status code</em>, and the second one is a <em>count of occurrences</em>.</p>

<p>And finally, we finished our application. Let’s review the whole code for <em>Master Actor</em>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Master</span><span class="o">(</span><span class="n">nWorkers</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Actor</span>
 <span class="k">with</span> <span class="nc">ActorLogging</span>
 <span class="k">with</span> <span class="nc">MasterHandler</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Master._</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Initialize</span> <span class="k">=&gt;</span>
      <span class="nv">log</span><span class="o">.</span><span class="py">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Spawning $nWorkers workers..."</span><span class="o">)</span>
      <span class="k">val</span> <span class="nv">workers</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">nWorkers</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="n">createWorker</span><span class="o">)</span>
      <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
      <span class="nf">sender</span><span class="o">()</span> <span class="o">!</span> <span class="nc">MasterInitialized</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">],</span>
                  <span class="n">currentWorker</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">line</span> <span class="k">@</span> <span class="nv">Ingestion</span><span class="o">.</span><span class="py">Line</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="nv">worker</span> <span class="k">=</span> <span class="nf">workers</span><span class="o">(</span><span class="n">currentWorker</span><span class="o">)</span>
      <span class="n">worker</span> <span class="o">!</span> <span class="n">line</span>
      <span class="k">val</span> <span class="nv">nextWorker</span> <span class="k">=</span> <span class="o">(</span><span class="n">currentWorker</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="nv">workers</span><span class="o">.</span><span class="py">length</span>
      <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">forwardTask</span><span class="o">(</span><span class="n">workers</span><span class="o">,</span> <span class="n">nextWorker</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">CollectResults</span> <span class="k">=&gt;</span>
      <span class="nv">workers</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="k">_</span> <span class="o">!</span> <span class="nv">Worker</span><span class="o">.</span><span class="py">ResultRequest</span><span class="o">)</span>
      <span class="nv">context</span><span class="o">.</span><span class="py">become</span><span class="o">(</span><span class="nf">collectResults</span><span class="o">())</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="nv">results</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ArrayBuffer</span><span class="o">[</span><span class="kt">Worker.ResultResponse</span><span class="o">]()</span>

  <span class="k">def</span> <span class="nf">collectResults</span><span class="o">()</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">response</span> <span class="k">@</span> <span class="nv">Worker</span><span class="o">.</span><span class="py">ResultResponse</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">results</span> <span class="o">+=</span> <span class="n">response</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">results</span><span class="o">.</span><span class="py">length</span> <span class="o">==</span> <span class="n">nWorkers</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">context</span><span class="o">.</span><span class="py">parent</span> <span class="o">!</span> <span class="nf">toAggregate</span><span class="o">(</span><span class="nv">results</span><span class="o">.</span><span class="py">toSeq</span><span class="o">)</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">createWorker</span><span class="o">(</span><span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">ActorRef</span> <span class="o">=</span>
    <span class="nv">context</span><span class="o">.</span><span class="py">actorOf</span><span class="o">(</span><span class="nv">Worker</span><span class="o">.</span><span class="py">props</span><span class="o">(</span><span class="n">index</span><span class="o">),</span> <span class="n">s</span><span class="s">"worker-$index"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>This is the last part of <em>Data processing with Akka Actors</em> series. Here is the source code if you want to play with it or even improve it.
Github repository: <a href="https://github.com/aleksandarskrbic/akka-actors-blog">Data processing with Akka Actors</a>.</p>

<p>You learned how to write a relatively simple application with Akka, how to design master-worker architecture and how to implement a few communication patterns between actors. There is a lot of improvements that can be added to this application. Some of them are to refactor codebase to use Typed Actors and to implement supervision strategy for actors. Check official Akka documentation on <a href="https://doc.akka.io/docs/akka/2.6/general/supervision.html">Supervision and Monitoring</a> to learn more about it. Another way to improve this application will be to completely remove <em>Master Actor</em> and to use <a href="https://doc.akka.io/docs/akka/current/routing.html">Akka Routers</a>, that can easily help us to distribute request among workers without worrying about algorithms like round-robin or some else, without need to implement them on your own, as we did here for the purpose of learning.</p>

<p>Some of these improvements will be a theme for another article.</p>

<p>You can find me at:</p>
<ul>
  <li><a href="https://www.linkedin.com/in/aleksandar-skrbic/">Linkedin</a></li>
  <li><a href="https://github.com/aleksandarskrbic">Github</a></li>
</ul>

<p>Or just send me a question to <a href="">skrbic.alexa@gmail.com</a></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#akka" class="page__taxonomy-item" rel="tag">akka</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#big-data" class="page__taxonomy-item" rel="tag">big data</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#jvm" class="page__taxonomy-item" rel="tag">jvm</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#scala" class="page__taxonomy-item" rel="tag">scala</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-04-10T00:00:00+02:00">April 10, 2020</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Data+processing+with+Akka+Actors%3A+Part+II%20http%3A%2F%2Flocalhost%3A4000%2Fakka-actors-2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fakka-actors-2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fakka-actors-2%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fakka-actors-2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="http://localhost:4000/akka-actors-1/" class="pagination--pager" title="Data processing with Akka Actors: Part I
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/akka-actors-1/" rel="permalink">Data processing with Akka Actors: Part I
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Scala, Akka, JVM, Big Data
</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="https://github.com/aleksandarskrbic"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Aleksandar Skrbic. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>










  </body>
</html>